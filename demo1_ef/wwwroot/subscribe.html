<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Subscribe</title>
<link rel="stylesheet" type="text/css" href="arena.css"/>
<script src="https://cdn.plot.ly/plotly-2.3.1.min.js"></script>
<style>

</style>
</head>
<body>


<h1>Subscribe</h1>

<form id="form">
	<p>
		<label for="producer_id">Producer</label><br>
		<select name="producer_id" graphql_option="producers{value:id name:name name1:quantity_name quantity_id}"></select>
	</p>
	<p><input type="submit"></p>
</form>

<div id="plot"></div>


<script src='basic.js'></script>
<script src='add.js'></script>
<script>
	//https://plotly.com/javascript/streaming/
function rand() {
return Math.random();
}

Plotly.newPlot('plot', [{
	x: [1,2,3].map(rand),
	y: [1,2,3].map(rand),
	mode: 'lines',
	line: {color: '#80CAF6'}
}]);

/*
var cnt = 0;
var interval = setInterval(function()
{
	Plotly.extendTraces('plot', {
	x: [[rand()]],
	y: [[rand()]]
	}, [0])
	if(++cnt === 100) clearInterval(interval);
}, 300);
*/





var element_output = document.getElementById("out");
var element_form = document.getElementById("form");


function ws_connect(producer_id)
{
	var url = ws_url("/subscribe_ws");
	console.log("WebSocket: ", url);
	socket = new WebSocket(url);
	socket.binaryType = "arraybuffer";
	socket.onopen = function (event)
	{
		console.log(event);
	};
	socket.onclose = function (event)
	{
		console.log(event);
	};
	socket.onerror = function (event)
	{
		console.log(event);
		element_output.innerText = "Unknown Error. You need to be /Siteadmin to connect to websocket.";
	};
	socket.onmessage = function (event)
	{
		const view = new DataView(event.data);
		console.log(buf2hex(event.data), view.getUint32(0, true), view.getBigInt64(4, true), view.getFloat32(12, true));
		console.log(new Date(Number(view.getBigInt64(4, true))));
		/*
		Plotly.extendTraces('plot', {
			x: [[rand()]],
			y: [[rand()]]
		}, [0]);
		*/
	};
};




element_form.onsubmit = (event) =>
{
	ws_connect(event.target.producer_id.value);
	event.preventDefault();
}

</script>
</body>
</html>



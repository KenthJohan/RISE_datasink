<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Subscribe</title>
<link rel="stylesheet" type="text/css" href="arena.css"/>
<script src="https://cdn.plot.ly/plotly-2.3.1.min.js"></script>
<style>
body
{
	display: flex;
	background-color: whitesmoke;
	gap: 12px;
}
#plot
{
	height: 100%;
}
</style>
</head>
<body>

<form id="form">
	<p>
		<label for="producer_id">Producer</label><br>
		<select name="producer_id" graphql_option="producers{value:id name:name name1:quantity_name quantity_id}"></select>
	</p>
	<p><input type="submit" value="Toggle subscription"></p>
</form>

<div id="plot"></div>


<script src='basic.js'></script>
<script src='add.js'></script>
<script>
	//https://plotly.com/javascript/streaming/

//var t = new Date();


/*
var cnt = 0;
var interval = setInterval(function()
{
	Plotly.extendTraces('plot', {
	x: [[rand()]],
	y: [[rand()]]
	}, [0])
	if(++cnt === 100) clearInterval(interval);
}, 300);
*/





var element_output = document.getElementById("out");
var element_form = document.getElementById("form");
var element_plot = document.getElementById("plot");




var layout = 
{
	showlegend: true,
};
Plotly.newPlot(element_plot, [], layout);

//console.log(element_plot);


function ws_togglesub(socket, producer_id)
{
	var buffer = new ArrayBuffer(4);
	var dv = new DataView(buffer);
	dv.setInt16(0, producer_id, true);
	console.log("Websocket send: ", buf2hex(buffer), " to ", socket.url);
	socket.send(buffer);
}


//When method = 0: Unsubscribe
//When method = 1: Subscribe
//When method = 2: Toggle subscription
function subscribe(socket, producer_id, longname, method)
{
	//Check if this is already subscribed:
	var trace_index = element_plot.data.findIndex(x => x.producer_id === producer_id);
	if (trace_index >= 0)
	{
		if ((method == 2) || (method == 0))
		{
			Plotly.deleteTraces(element_plot, trace_index);
			ws_togglesub(socket, producer_id);
			console.log("Unsubscribe", producer_id, trace_index);
		}
		else
		{
			console.log("The producer " + producer_id + " is already subscribed");
		}
	}
	else if ((method == 2) || (method == 1))
	{
		ws_togglesub(socket, producer_id);
		var trace =
		{
			visible: true,
			x: [null],
			y: [null],
			name: longname ? longname : ("Producer " + producer_id),
			type: 'scatter',
			producer_id: producer_id
		};
		console.log("Subscribe", producer_id, trace_index);
		Plotly.addTraces(element_plot, trace);
	}
}







function ws_connect(url)
{
	console.log("WebSocket open:", url);
	var socket = new WebSocket(url);
	socket.binaryType = "arraybuffer";
	socket.onopen = function (event)
	{
		console.log("WebSocket onopen: ", url, event);
		/*
		var buffer = new ArrayBuffer(4);
		var dv = new DataView(buffer);
		dv.setInt16(0, producer_id, true);
		console.log("Sending:", buf2hex(buffer));
		socket.send(buffer);
		*/
	};
	socket.onclose = function (event)
	{
		console.log("WebSocket onclose: ", event);
	};
	socket.onerror = function (event)
	{
		console.warn("WebSocket onerror: ", event);
		//element_output.innerText = "Unknown Error. You need to be /Siteadmin to connect to websocket.";
	};
	socket.onmessage = function (event)
	{
		const view = new DataView(event.data);
		//console.log(view);
		console.log(buf2hex(event.data), view.getInt32(0, true), new Date(Number(view.getBigInt64(4, true))), view.getFloat32(12, true));
		//console.log(new Date(Number(view.getBigInt64(4, true))));
		var producer_id = view.getInt32(0, true);
		var time = new Date(Number(view.getBigInt64(4, true)));
		var value = view.getFloat32(12, true);
		var trace_index = element_plot.data.findIndex(x => x.producer_id === producer_id);
		Plotly.extendTraces('plot', {
			x: [[time.toISOString()]],
			y: [[value]]
		}, [trace_index]);
		/*
		Plotly.extendTraces('plot', {
			x: [[rand()]],
			y: [[rand()]]
		}, [0]);
		*/
	};
	return socket;
};



var url = ws_url("/ws/sub");
var socket = ws_connect(url);

element_form.onsubmit = (event) =>
{
	var producer_id = Number(event.target.producer_id.value);
	var producer_longname = event.target.producer_id.querySelector('option[value="'+producer_id+'"]').innerText;
	event.preventDefault();
	subscribe(socket, producer_id, producer_longname, 2);
	//ws_connect(event.target.producer_id.value);
	/*
	Plotly.addTraces('plot', 
	{
		x: [],
		y: [],
		mode: 'lines',
		line: {color: '#80CA06'}
	});
	*/
}




</script>
</body>
</html>



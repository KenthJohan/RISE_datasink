<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Subscribe</title>
<link rel="stylesheet" type="text/css" href="arena.css"/>
<script src="https://cdn.plot.ly/plotly-2.3.1.min.js"></script>
<style>

</style>
</head>
<body>


<h1>Subscribe</h1>

<form id="form">
	<p>
		<label for="producer_id">Producer</label><br>
		<select name="producer_id" graphql_option="producers{value:id name:name name1:quantity_name quantity_id}"></select>
	</p>
	<p><input type="submit"></p>
</form>

<div id="plot"></div>


<script src='basic.js'></script>
<script src='add.js'></script>
<script>
	//https://plotly.com/javascript/streaming/
function rand() {
return Math.random();
}
//var t = new Date();
Plotly.newPlot('plot', [
{
	x: [],
	y: [],
	mode: 'lines',
	line: {color: '#80CAF6'}
},
{
	x: [],
	y: [],
	mode: 'lines',
	line: {color: '#00CAF6'}
},
{
	x: [],
	y: [],
	mode: 'lines',
	line: {color: '#800AF6'}
},
{
	x: [],
	y: [],
	mode: 'lines',
	line: {color: '#80CA06'}
},
]);

/*
var cnt = 0;
var interval = setInterval(function()
{
	Plotly.extendTraces('plot', {
	x: [[rand()]],
	y: [[rand()]]
	}, [0])
	if(++cnt === 100) clearInterval(interval);
}, 300);
*/





var element_output = document.getElementById("out");
var element_form = document.getElementById("form");

function ws_subscribe(socket, producer_id)
{
	var buffer = new ArrayBuffer(4);
	var dv = new DataView(buffer);
	dv.setInt16(0, producer_id, true);
	console.log("Sending:", buf2hex(buffer));
	socket.send(buffer);
}

function ws_connect(url)
{
	console.log("WebSocket opening:", url);
	var socket = new WebSocket(url);
	socket.binaryType = "arraybuffer";
	socket.onopen = function (event)
	{
		console.log("WebSocket onopen: ", url, event);
		/*
		var buffer = new ArrayBuffer(4);
		var dv = new DataView(buffer);
		dv.setInt16(0, producer_id, true);
		console.log("Sending:", buf2hex(buffer));
		socket.send(buffer);
		*/
	};
	socket.onclose = function (event)
	{
		console.log(event);
	};
	socket.onerror = function (event)
	{
		console.warn(event);
		//element_output.innerText = "Unknown Error. You need to be /Siteadmin to connect to websocket.";
	};
	socket.onmessage = function (event)
	{
		const view = new DataView(event.data);
		//console.log(view);
		console.log(buf2hex(event.data), view.getInt32(0, true), new Date(Number(view.getBigInt64(4, true))), view.getFloat32(12, true));
		//console.log(new Date(Number(view.getBigInt64(4, true))));
		var producer_id = view.getInt32(0, true);
		var time = new Date(Number(view.getBigInt64(4, true)));
		var value = view.getFloat32(12, true);
		Plotly.extendTraces('plot', {
			x: [[time.toISOString()]],
			y: [[value]]
		}, [producer_id]);
		/*
		Plotly.extendTraces('plot', {
			x: [[rand()]],
			y: [[rand()]]
		}, [0]);
		*/
	};
	return socket;
};



var url = ws_url("/subscribe_ws");
var socket = ws_connect(url);

element_form.onsubmit = (event) =>
{
	event.preventDefault();
	ws_subscribe(socket, event.target.producer_id.value);
	//ws_connect(event.target.producer_id.value);
	/*
	Plotly.addTraces('plot', 
	{
		x: [],
		y: [],
		mode: 'lines',
		line: {color: '#80CA06'}
	});
	*/
}




</script>
</body>
</html>



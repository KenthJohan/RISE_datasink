<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Subscribe</title>
<link rel="stylesheet" type="text/css" href="arena.css"/>
<script src="https://cdn.plot.ly/plotly-2.3.1.min.js"></script>
<style>

</style>
</head>
<body>


<h1>Subscribe</h1>

<form id="form">
	<p>
		<label for="producer_id">Producer</label><br>
		<select name="producer_id" graphql_option="producers{value:id name:name name1:quantity_name quantity_id}"></select>
	</p>
	<p><input type="submit" value="Toggle subscription"></p>
</form>

<div id="plot"></div>


<script src='basic.js'></script>
<script src='add.js'></script>
<script>
	//https://plotly.com/javascript/streaming/

//var t = new Date();


/*
var cnt = 0;
var interval = setInterval(function()
{
	Plotly.extendTraces('plot', {
	x: [[rand()]],
	y: [[rand()]]
	}, [0])
	if(++cnt === 100) clearInterval(interval);
}, 300);
*/





var element_output = document.getElementById("out");
var element_form = document.getElementById("form");
var element_plot = document.getElementById("plot");
var traces = {};





Plotly.newPlot(element_plot, []);

//console.log(element_plot);


function ws_togglesub(socket, producer_id)
{
	var buffer = new ArrayBuffer(4);
	var dv = new DataView(buffer);
	dv.setInt16(0, producer_id, true);
	console.log("Sending:", buf2hex(buffer));
	socket.send(buffer);
}


//When method = 0: Unsubscribe
//When method = 1: Subscribe
//When method = 2: Toggle subscription
function subscribe(socket, producer_id, method)
{
	//Check if this is already subscribed:
	if (producer_id in traces)
	{
		if ((method == 2) || (method == 0))
		{
			var trace_index = traces[producer_id];
			Plotly.deleteTraces(element_plot, trace_index);
			ws_togglesub(socket, producer_id);
			console.log("Unsubscribe", producer_id, trace_index);
			delete traces[producer_id];
		}
		else
		{
			console.log("The producer " + producer_id + " is already subscribed");
		}
	}
	else if ((method == 2) || (method == 1))
	{
		ws_togglesub(socket, producer_id);
		var trace =
		{
			x: [],
			y: [],
			name: "Producer " + producer_id,
			type: 'scatter'
		};
		traces[producer_id] = element_plot.data.length;
		console.log("Subscribe", producer_id, traces[producer_id]);
		Plotly.addTraces(element_plot, trace);
	}
	console.log(element_plot.data);
}







function ws_connect(url)
{
	console.log("WebSocket opening:", url);
	var socket = new WebSocket(url);
	socket.binaryType = "arraybuffer";
	socket.onopen = function (event)
	{
		console.log("WebSocket onopen: ", url, event);
		/*
		var buffer = new ArrayBuffer(4);
		var dv = new DataView(buffer);
		dv.setInt16(0, producer_id, true);
		console.log("Sending:", buf2hex(buffer));
		socket.send(buffer);
		*/
	};
	socket.onclose = function (event)
	{
		console.log(event);
	};
	socket.onerror = function (event)
	{
		console.warn(event);
		//element_output.innerText = "Unknown Error. You need to be /Siteadmin to connect to websocket.";
	};
	socket.onmessage = function (event)
	{
		const view = new DataView(event.data);
		//console.log(view);
		console.log(buf2hex(event.data), view.getInt32(0, true), new Date(Number(view.getBigInt64(4, true))), view.getFloat32(12, true));
		//console.log(new Date(Number(view.getBigInt64(4, true))));
		var producer_id = view.getInt32(0, true);
		var time = new Date(Number(view.getBigInt64(4, true)));
		var value = view.getFloat32(12, true);
		var trace_index = traces[producer_id];
		Plotly.extendTraces('plot', {
			x: [[time.toISOString()]],
			y: [[value]]
		}, [trace_index]);
		/*
		Plotly.extendTraces('plot', {
			x: [[rand()]],
			y: [[rand()]]
		}, [0]);
		*/
	};
	return socket;
};



var url = ws_url("/subscribe_ws");
var socket = ws_connect(url);

element_form.onsubmit = (event) =>
{
	event.preventDefault();
	subscribe(socket, event.target.producer_id.value, 2);
	//ws_connect(event.target.producer_id.value);
	/*
	Plotly.addTraces('plot', 
	{
		x: [],
		y: [],
		mode: 'lines',
		line: {color: '#80CA06'}
	});
	*/
}




</script>
</body>
</html>


